<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>棒針編み図エディタ</title>
  <style>
    /* 基本設定と変数 */
    :root {
      --cell-size: 30px; /* セルのサイズ。スマホ用はメディアクエリで調整 */
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      padding: 10px;
    }

    /* ツールバーのスタイル: レスポンシブ対応 */
    #toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    #toolbar input,
    #toolbar select,
    #toolbar button {
      font-size: 16px;
    }

    button {
      padding: 8px 12px;
      cursor: pointer;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }

    /* グリッドコンテナ: レスポンシブ対応のスクロール設定 */
    #grid-container {
      background-color: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: repeat(20, var(--cell-size)); /* 列数はJSで更新 */
      gap: 0;
      overflow: auto;
    }

    /* セルのスタイル */
    .cell {
      width: var(--cell-size);
      height: var(--cell-size);
      border: 1px solid #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    /* ステッチ記号のスタイル */
    .stitch-symbol {
      pointer-events: none;
      font-size: calc(var(--cell-size) * 0.8);
      line-height: 1;
    }

    /* グリッドサイズ入力欄 */
    #grid-rows-input,
    #grid-cols-input {
      width: 60px;
      height: 30px;
    }

    /* カラーピッカー */
    #color-picker {
      width: 30px;
      height: 30px;
      border: none;
      padding: 0;
    }

    /* スマホ用メディアクエリ */
    @media (max-width: 480px) {
      :root {
        --cell-size: 25px;
      }
      #toolbar input,
      #toolbar select,
      #toolbar button {
        font-size: 14px;
      }
      #grid-rows-input,
      #grid-cols-input {
        width: 50px;
        height: 25px;
      }
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <input type="color" id="color-picker" value="#ff0000">
    <select id="stitch-type">
      <option value="knit">表目</option>
      <option value="purl">裏目</option>
      <option value="yo">かけ目</option>
      <option value="right_up_two_one">右上2目一度</option>
      <option value="left_up_two_one">左上2目一度</option>
      <option value="purl_left_up_two_one">裏目の左上2目一度</option>
      <option value="middle_up_three_one">中上3目一度</option>
      <option value="right_up_three_one">右上3目一度</option>
      <option value="left_up_three_one">左上3目一度</option>
      <option value="right_up_two_cross">右上2目交差</option>
      <option value="left_up_two_cross">左上2目交差</option>
      <option value="slip_stitch">すべり目</option>
      <option value="twist_stitch">ねじり目</option>
    </select>
    <label for="grid-rows-input">行数:</label>
    <input type="number" id="grid-rows-input" value="20" min="1">
    <label for="grid-cols-input">列数:</label>
    <input type="number" id="grid-cols-input" value="20" min="1">
    <button id="update-grid-size">グリッド更新</button>
    <button onclick="downloadChart()">画像保存</button>
    <button onclick="clearGrid()">全体クリア</button>
  </div>
  <div id="grid-container"></div>

  <script>
    let numRows = 20; // 行数
    let numCols = 20; // 列数
    let selectedColor = '#ff0000';
    let selectedStitch = 'knit';
    let grid = [];
    let touchTimer = null; // 長押し判定用タイマー

    // 保存されたグリッドの状態を読み出す関数
    function loadGridState() {
      const saved = localStorage.getItem('knittingChartData');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data && data.numRows && data.numCols && data.grid) {
            numRows = data.numRows;
            numCols = data.numCols;
            grid = data.grid;
            // 入力欄にも反映
            document.getElementById('grid-rows-input').value = numRows;
            document.getElementById('grid-cols-input').value = numCols;
          }
        } catch (e) {
          console.error("保存されたデータの読み込みに失敗しました", e);
        }
      }
    }

    // 現在のグリッド状態を localStorage に保存する関数
    function saveGridState() {
      const data = { numRows, numCols, grid };
      localStorage.setItem('knittingChartData', JSON.stringify(data));
    }

    // グリッドの初期化
    function initGrid() {
      const container = document.getElementById('grid-container');
      container.innerHTML = '';
      // 入力された列数に合わせて grid-template-columns を更新
      container.style.gridTemplateColumns = `repeat(${numCols}, var(--cell-size))`;
      
      // grid が未定義またはサイズが変わっている場合は新規作成
      if (!grid || grid.length !== numRows) {
        grid = [];
        for (let i = 0; i < numRows; i++) {
          grid[i] = [];
          for (let j = 0; j < numCols; j++) {
            grid[i][j] = { type: 'empty', color: '#ffffff' };
          }
        }
      }
      
      // グリッド上の各セルを生成する
      for (let i = 0; i < numRows; i++) {
        for (let j = 0; j < numCols; j++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = i;
          cell.dataset.col = j;
          cell.addEventListener('click', handleCellClick);
          // PC用：右クリックでセルをクリア
          cell.addEventListener('contextmenu', clearCell);
          // スマホ用：長押しでセルをクリア
          cell.addEventListener('touchstart', handleTouchStart);
          cell.addEventListener('touchend', handleTouchEnd);
          cell.appendChild(createStitchSymbol(grid[i][j].type));
          container.appendChild(cell);
          // セルの見た目を更新（色など）
          updateCellDisplay(cell);
        }
      }
      // グリッド状態を保存
      saveGridState();
    }

    // セルに表示するステッチ記号の作成
    function createStitchSymbol(type) {
      const symbol = document.createElement('div');
      symbol.className = 'stitch-symbol';
      symbol.innerHTML = getStitchSymbol(type);
      return symbol;
    }

    // セルクリック時の処理
    function handleCellClick(e) {
        const cell = e.currentTarget;
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);

        // すでに同じ記号がセットされている場合はクリア、それ以外の場合は新たな記号をセット
        if (grid[row][col].type === selectedStitch) {
            grid[row][col] = { type: 'empty', color: '#ffffff' };
        } else {
            grid[row][col] = {
            type: selectedStitch,
            color: selectedColor
            };
        }
        updateCellDisplay(cell);
        saveGridState();
    }

    // セルの表示更新
    function updateCellDisplay(cell) {
      const symbol = cell.querySelector('.stitch-symbol');
      const cellData = grid[cell.dataset.row][cell.dataset.col];
      symbol.innerHTML = getStitchSymbol(cellData.type);
      symbol.style.color = cellData.color;
    }

    // 右クリックでセルをクリアする処理
    function clearCell(e) {
      e.preventDefault(); // コンテキストメニューを表示させない
      const cell = e.currentTarget;
      const row = parseInt(cell.dataset.row);
      const col = parseInt(cell.dataset.col);
      grid[row][col] = { type: 'empty', color: '#ffffff' };
      updateCellDisplay(cell);
      saveGridState();
    }

    // スマホ用：タッチ開始で長押しタイマーを開始
    function handleTouchStart(e) {
      const cell = e.currentTarget;
      // 長押し判定（800ms以上でクリア）
      touchTimer = setTimeout(() => {
        clearCell(e);
      }, 800);
    }

    // スマホ用：タッチ解除でタイマーをクリア
    function handleTouchEnd(e) {
      clearTimeout(touchTimer);
    }

    // 各ステッチ記号の取得
    function getStitchSymbol(type) {
      switch (type) {
        case 'knit': return '─';
        case 'purl': return '○';
        case 'yo': return '△';
        case 'right_up_two_one': return '↗2';
        case 'left_up_two_one': return '↖2';
        case 'purl_left_up_two_one': return '↰2';
        case 'middle_up_three_one': return '⇧3';
        case 'right_up_three_one': return '↗3';
        case 'left_up_three_one': return '↖3';
        case 'right_up_two_cross': return '↗2×';
        case 'left_up_two_cross': return '↖2×';
        case 'slip_stitch': return '∿';
        case 'twist_stitch': return '↻';
        default: return '';
      }
    }

    // 画像保存機能（html2canvas 必須）
    function downloadChart() {
      html2canvas(document.querySelector("#grid-container")).then(canvas => {
        const link = document.createElement('a');
        link.download = 'knitting-chart.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    // 全体クリア機能
    function clearGrid() {
      // 全体クリア時は、グリッドを空にして再生成
      grid = [];
      initGrid();
      saveGridState();
    }

    // グリッドサイズ更新関数（行数・列数を個別に更新）
    function updateGridSize() {
      const rowsInput = document.getElementById('grid-rows-input');
      const colsInput = document.getElementById('grid-cols-input');
      const newRows = parseInt(rowsInput.value);
      const newCols = parseInt(colsInput.value);
      if (!isNaN(newRows) && newRows > 0 && !isNaN(newCols) && newCols > 0) {
        numRows = newRows;
        numCols = newCols;
        // サイズ変更時は新たにグリッドを初期化
        initGrid();
        saveGridState();
      } else {
        alert('正しい行数・列数を入力してください');
      }
    }

    // 各イベントリスナーの設定
    document.getElementById('color-picker').addEventListener('input', (e) => {
      selectedColor = e.target.value;
    });
    document.getElementById('stitch-type').addEventListener('change', (e) => {
      selectedStitch = e.target.value;
    });
    document.getElementById('update-grid-size').addEventListener('click', updateGridSize);

    // ページ読み込み時に保存済みのデータがあれば読み込み、グリッドを生成
    loadGridState();
    initGrid();
  </script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>